# üöÄ Phase 1.1 : Setup FastAPI

## üéØ Objectif
Cr√©er la structure backend FastAPI de base avec configuration, routes, et middleware.

**Dur√©e estim√©e** : 2 heures  
**Pr√©requis** : Python 3.9+, pip, venv

---

## üìã Ce que nous allons cr√©er

```
backend/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # ‚Üê Point d'entr√©e FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py      # ‚Üê D√©pendances injectables
‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ       ‚îî‚îÄ‚îÄ __init__.py
```

---

## üîß √âtape 1 : Installer les D√©pendances

### 1.1 Activer l'environnement virtuel

```bash
cd /home/vincheetah/Documents/Travail/FFSU/PyCalendar
source .venv/bin/activate
```

### 1.2 Installer FastAPI et d√©pendances

```bash
pip install fastapi uvicorn[standard] python-multipart
pip install sqlalchemy pydantic-settings
```

### 1.3 Mettre √† jour requirements.txt

```bash
pip freeze > requirements.txt
```

**V√©rification** :
```bash
pip list | grep fastapi
# Devrait afficher : fastapi 0.104.x ou plus
```

---

## üèóÔ∏è √âtape 2 : Cr√©er la Structure Backend

### 2.1 Cr√©er les dossiers

```bash
mkdir -p backend/api/routes
```

### 2.2 Cr√©er les fichiers `__init__.py`

```bash
touch backend/__init__.py
touch backend/api/__init__.py
touch backend/api/routes/__init__.py
```

---

## üìù √âtape 3 : Cr√©er le Point d'Entr√©e FastAPI

### 3.1 Cr√©er `backend/api/main.py`

**Objectif** : Configurer FastAPI avec CORS, routes, et endpoints de base

```python
"""
PyCalendar API - Point d'entr√©e principal
G√®re la configuration FastAPI, CORS, et routing.
"""
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager

# Version de l'API
API_VERSION = "2.0.0"
API_TITLE = "PyCalendar API"
API_DESCRIPTION = """
API REST pour la gestion de calendriers sportifs.

## Features

* **Projets** : Gestion de projets multi-sports
* **Matchs** : CRUD matchs avec planification
* **√âquipes** : Gestion des √©quipes et institutions
* **Gymnases** : Gestion des lieux et cr√©neaux
* **Solver** : Ex√©cution des algorithmes de planification
* **Export** : Export Excel, iCal, PDF
"""


@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    Gestion du cycle de vie de l'application.
    Ex√©cut√© au d√©marrage et √† l'arr√™t.
    """
    # Startup
    print("üöÄ PyCalendar API d√©marrage...")
    print(f"üìö Documentation: http://localhost:8000/docs")
    print(f"üîÑ Redoc: http://localhost:8000/redoc")
    
    yield
    
    # Shutdown
    print("üëã PyCalendar API arr√™t...")


# Cr√©ation de l'application FastAPI
app = FastAPI(
    title=API_TITLE,
    description=API_DESCRIPTION,
    version=API_VERSION,
    lifespan=lifespan,
    docs_url="/docs",
    redoc_url="/redoc",
    openapi_url="/openapi.json",
)


# ============================================================================
# CORS Configuration
# ============================================================================

# Origins autoris√©es (√† ajuster selon environnement)
origins = [
    "http://localhost:5173",  # Vite dev server
    "http://localhost:3000",  # React dev server alternatif
    "http://127.0.0.1:5173",
    "http://127.0.0.1:3000",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],  # Permet GET, POST, PUT, DELETE, etc.
    allow_headers=["*"],  # Permet tous les headers
)


# ============================================================================
# Routes de Base
# ============================================================================

@app.get("/", tags=["Root"])
async def root():
    """
    Endpoint racine - Informations sur l'API.
    """
    return {
        "name": API_TITLE,
        "version": API_VERSION,
        "status": "running",
        "documentation": "/docs",
        "endpoints": {
            "projects": "/api/projects",
            "matches": "/api/matches",
            "teams": "/api/teams",
            "venues": "/api/venues",
        }
    }


@app.get("/health", tags=["Health"])
async def health_check():
    """
    Endpoint de sant√© pour monitoring.
    Utile pour les health checks Docker/Kubernetes.
    """
    return {
        "status": "healthy",
        "version": API_VERSION,
    }


@app.get("/api", tags=["API"])
async def api_info():
    """
    Informations sur l'API.
    """
    return {
        "version": API_VERSION,
        "title": API_TITLE,
        "description": "API REST pour gestion de calendriers sportifs",
    }


# ============================================================================
# Routes Modules (√† ajouter progressivement)
# ============================================================================

# from .routes import projects, matches, teams, venues

# app.include_router(
#     projects.router,
#     prefix="/api/projects",
#     tags=["Projects"]
# )
# app.include_router(
#     matches.router,
#     prefix="/api/matches",
#     tags=["Matches"]
# )
# app.include_router(
#     teams.router,
#     prefix="/api/teams",
#     tags=["Teams"]
# )
# app.include_router(
#     venues.router,
#     prefix="/api/venues",
#     tags=["Venues"]
# )


# ============================================================================
# Exception Handlers (optionnel)
# ============================================================================

from fastapi import Request, status
from fastapi.responses import JSONResponse
from fastapi.exceptions import RequestValidationError

@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    """
    Handler personnalis√© pour les erreurs de validation Pydantic.
    Retourne un message d'erreur plus clair.
    """
    return JSONResponse(
        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        content={
            "detail": "Erreur de validation",
            "errors": exc.errors(),
        },
    )


# ============================================================================
# Run (pour d√©veloppement uniquement)
# ============================================================================

if __name__ == "__main__":
    import uvicorn
    
    uvicorn.run(
        "backend.api.main:app",
        host="0.0.0.0",
        port=8000,
        reload=True,  # Auto-reload en dev
        log_level="info",
    )
```

**Points cl√©s** :
- ‚úÖ CORS configur√© pour frontend local
- ‚úÖ Endpoints de base (`/`, `/health`, `/api`)
- ‚úÖ Documentation auto-g√©n√©r√©e (`/docs`)
- ‚úÖ Gestion cycle de vie (startup/shutdown)
- ‚úÖ Handler erreurs de validation

---

### 3.2 Cr√©er `backend/api/dependencies.py`

**Objectif** : Fonctions de d√©pendances r√©utilisables (DB session, config, etc.)

```python
"""
Dependencies pour FastAPI.
Fonctions injectables dans les routes via Depends().
"""
from typing import Generator
from fastapi import Depends, HTTPException, status


# ============================================================================
# Database Dependencies (sera impl√©ment√© dans guide suivant)
# ============================================================================

def get_db():
    """
    Dependency pour obtenir une session de base de donn√©es.
    
    Usage:
        @app.get("/items/")
        def read_items(db: Session = Depends(get_db)):
            ...
    
    Note: Impl√©mentation compl√®te dans 02_database_models.md
    """
    # TODO: Impl√©menter avec SQLAlchemy SessionLocal
    # db = SessionLocal()
    # try:
    #     yield db
    # finally:
    #     db.close()
    pass


# ============================================================================
# Config Dependencies
# ============================================================================

def get_config():
    """
    Dependency pour obtenir la configuration globale.
    
    Usage:
        @app.get("/config/")
        def read_config(config: Config = Depends(get_config)):
            ...
    """
    from core.config import Config
    # Charger config par d√©faut
    # TODO: G√©rer config par projet
    return Config.from_yaml("configs/default.yaml")


# ============================================================================
# Authentication Dependencies (Phase 6)
# ============================================================================

async def get_current_user():
    """
    Dependency pour obtenir l'utilisateur authentifi√©.
    
    √Ä impl√©menter dans Phase 6 (Authentification).
    
    Usage:
        @app.get("/me/")
        def read_user_me(current_user: User = Depends(get_current_user)):
            ...
    """
    # TODO: Impl√©menter avec JWT tokens
    raise HTTPException(
        status_code=status.HTTP_501_NOT_IMPLEMENTED,
        detail="Authentification non impl√©ment√©e"
    )


# ============================================================================
# Pagination Dependencies
# ============================================================================

def pagination_params(
    skip: int = 0,
    limit: int = 100
):
    """
    Dependency pour param√®tres de pagination.
    
    Args:
        skip: Nombre d'√©l√©ments √† sauter
        limit: Nombre maximum d'√©l√©ments √† retourner
    
    Returns:
        Dict avec skip et limit
    
    Usage:
        @app.get("/items/")
        def read_items(pagination: dict = Depends(pagination_params)):
            skip = pagination["skip"]
            limit = pagination["limit"]
            ...
    """
    if skip < 0:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="skip doit √™tre >= 0"
        )
    if limit < 1 or limit > 1000:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="limit doit √™tre entre 1 et 1000"
        )
    
    return {"skip": skip, "limit": limit}


# ============================================================================
# Validation Dependencies
# ============================================================================

def validate_project_exists(project_id: int, db = Depends(get_db)):
    """
    Dependency pour valider qu'un projet existe.
    
    Args:
        project_id: ID du projet
        db: Session de base de donn√©es
    
    Raises:
        HTTPException 404 si projet n'existe pas
    
    Returns:
        Le projet s'il existe
    
    Usage:
        @app.get("/projects/{project_id}/matches/")
        def read_matches(
            project = Depends(validate_project_exists)
        ):
            ...
    """
    # TODO: Impl√©menter apr√®s cr√©ation models DB
    pass
```

**Points cl√©s** :
- ‚úÖ D√©pendances r√©utilisables
- ‚úÖ Pagination standardis√©e
- ‚úÖ Validation d'existence
- ‚úÖ Placeholder pour auth future

---

## ‚úÖ √âtape 4 : Tester le Setup

### 4.1 Lancer le serveur

```bash
cd /home/vincheetah/Documents/Travail/FFSU/PyCalendar
uvicorn backend.api.main:app --reload --host 0.0.0.0 --port 8000
```

**Sortie attendue** :
```
üöÄ PyCalendar API d√©marrage...
üìö Documentation: http://localhost:8000/docs
üîÑ Redoc: http://localhost:8000/redoc
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [xxxxx] using WatchFiles
INFO:     Started server process [xxxxx]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

### 4.2 Tester les endpoints

**Option 1 : Navigateur**
- Ouvrir http://localhost:8000 ‚Üí Devrait afficher JSON avec infos API
- Ouvrir http://localhost:8000/docs ‚Üí Documentation Swagger UI
- Ouvrir http://localhost:8000/health ‚Üí `{"status": "healthy"}`

**Option 2 : curl**
```bash
# Endpoint racine
curl http://localhost:8000/
# {"name":"PyCalendar API","version":"2.0.0","status":"running"...}

# Health check
curl http://localhost:8000/health
# {"status":"healthy","version":"2.0.0"}

# API info
curl http://localhost:8000/api
# {"version":"2.0.0","title":"PyCalendar API"...}
```

**Option 3 : Swagger UI**
1. Ouvrir http://localhost:8000/docs
2. Cliquer sur `/` GET
3. Cliquer "Try it out"
4. Cliquer "Execute"
5. V√©rifier la r√©ponse

---

## üì∏ Captures d'√âcran Attendues

### Swagger UI
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PyCalendar API                         2.0.0‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ Root                                         ‚îÇ
‚îÇ ‚îú‚îÄ GET  /        Endpoint racine           ‚îÇ
‚îÇ ‚îú‚îÄ GET  /health  Health check              ‚îÇ
‚îÇ ‚îî‚îÄ GET  /api     API info                   ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ [Schemas] [Authorize]                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üêõ Troubleshooting

### Erreur : `ModuleNotFoundError: No module named 'fastapi'`
**Solution** :
```bash
source .venv/bin/activate
pip install fastapi uvicorn[standard]
```

### Erreur : `Address already in use`
**Solution** :
```bash
# Trouver le processus sur port 8000
lsof -i :8000

# Tuer le processus
kill -9 <PID>

# Ou utiliser un autre port
uvicorn backend.api.main:app --reload --port 8001
```

### Erreur CORS dans navigateur
**Solution** : V√©rifier que l'origin frontend est dans la liste `origins` de `main.py`

---

## ‚úÖ Crit√®res de Validation

Avant de passer au guide suivant, v√©rifier que :

- [ ] Le serveur d√©marre sans erreur
- [ ] http://localhost:8000/ retourne un JSON valide
- [ ] http://localhost:8000/docs affiche Swagger UI
- [ ] http://localhost:8000/health retourne `{"status": "healthy"}`
- [ ] Pas d'erreurs dans la console
- [ ] Hot reload fonctionne (modifier `main.py` ‚Üí serveur recharge)

---

## üéØ Prochaines √âtapes

Une fois ce guide compl√©t√© :

1. **Commit** :
   ```bash
   git add backend/
   git commit -m "feat(backend): Setup FastAPI structure"
   ```

2. **Passer au guide suivant** :
   ```bash
   cat docs/implementation/phase1/02_database_models.md
   ```

---

## üìö R√©f√©rences

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [FastAPI CORS](https://fastapi.tiangolo.com/tutorial/cors/)
- [Uvicorn Settings](https://www.uvicorn.org/settings/)
- [OpenAPI Specification](https://swagger.io/specification/)

---

**Dur√©e r√©elle** : _____ heures  
**Difficult√©s rencontr√©es** : _____  
**Notes** : _____
